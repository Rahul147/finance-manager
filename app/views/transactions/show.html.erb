<% merchant = @transaction.merchant.presence || "Unknown merchant" %>
<% category = @transaction.category.presence || "Uncategorized" %>
<% transaction_date = @transaction.transaction_date || @transaction.created_at.to_date %>
<% relative_time = time_ago_in_words(@transaction.created_at) %>
<% currency = @transaction.currency.presence || "₹" %>
<% amount_display = transaction_amount_display(@transaction) %>
<% email = @transaction.email %>
<% status_label = @transaction.status.presence || "Unlabeled" %>
<% status_styles = transaction_status_styles(@transaction.status) %>
<% type_label = @transaction.transaction_type_label || "Unclassified" %>

<div class="min-h-screen bg-[#efe6d7]">
  <div class="mx-auto max-w-5xl space-y-6 px-5 py-8 md:py-12">
    <div class="flex flex-wrap items-center gap-3">
      <%= link_to transactions_path,
          class: "inline-flex items-center gap-2 rounded-2xl border-2 border-black bg-white px-4 py-2 font-semibold text-slate-900 shadow-[0_5px_0_#000] transition hover:-translate-y-0.5" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Back to transactions</span>
      <% end %>
      <p class="text-sm font-medium text-slate-500">Transaction ID • <%= @transaction.id %></p>
    </div>

    <div class="space-y-5 rounded-3xl border-2 border-black bg-[#fdebd0] p-6 shadow-[10px_10px_0_#000]">
      <div class="flex flex-wrap items-start gap-4">
        <div class="min-w-0 flex-1 space-y-2">
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Merchant</p>
          <h1 class="text-3xl font-black leading-tight text-slate-900 md:text-4xl"><%= merchant %></h1>
          <p class="text-sm font-medium text-slate-600"><%= category %> • <%= currency %> • <%= type_label %></p>
        </div>
        <div class="text-right">
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Amount</p>
          <p class="text-3xl font-black text-slate-900"><%= amount_display %></p>
          <span class="mt-3 inline-flex items-center rounded-full border-2 border-black px-4 py-1 text-xs font-semibold uppercase tracking-wide shadow-[0_3px_0_#000] <%= status_styles %>">
            <%= status_label %>
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div class="rounded-2xl border-2 border-black bg-white p-4 shadow-[5px_5px_0_#000]">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Transaction date</p>
          <p class="mt-1 font-semibold text-slate-900"><%= transaction_date %></p>
          <p class="text-sm text-slate-500"><%= relative_time %> ago</p>
        </div>
        <div class="rounded-2xl border-2 border-black bg-white p-4 shadow-[5px_5px_0_#000]">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Currency</p>
          <p class="mt-1 font-semibold text-slate-900"><%= currency %></p>
          <p class="text-sm text-slate-500">Captured at sync</p>
        </div>
        <div class="rounded-2xl border-2 border-black bg-white p-4 shadow-[5px_5px_0_#000]">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Transaction type</p>
          <p class="mt-1 font-semibold text-slate-900"><%= type_label %></p>
          <p class="text-sm text-slate-500">Manual classification</p>
        </div>
        <div class="rounded-2xl border-2 border-black bg-white p-4 shadow-[5px_5px_0_#000]">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Reference</p>
          <p class="mt-1 break-words font-mono text-sm text-slate-700"><%= @transaction.id %>-<%= @transaction.created_at.to_i %></p>
          <p class="text-sm text-slate-500">Generated by Finance Manager</p>
        </div>
        <div class="rounded-2xl border-2 border-black bg-white p-4 shadow-[5px_5px_0_#000]">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Linked email</p>
          <% if email.present? %>
            <p class="mt-1 font-semibold text-slate-900"><%= email.subject.presence || "(no subject)" %></p>
            <%= link_to "Open email",
                email_path(email),
                class: "mt-2 inline-flex items-center gap-2 text-sm font-semibold text-blue-700 underline decoration-2" %>
          <% else %>
            <p class="mt-1 font-semibold text-slate-500">Not connected</p>
            <p class="text-sm text-slate-400">Attach an email to see the context.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="rounded-3xl border-2 border-black bg-white p-6 shadow-[12px_12px_0_#000]">
      <div class="flex flex-wrap items-center justify-between gap-4 border-b border-black/10 pb-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Notes</p>
          <p class="text-sm text-slate-500"><%= @transaction.notes.present? ? "Captured during review" : "No notes yet" %></p>
        </div>
        <% if email.present? %>
          <div class="rounded-full border-2 border-black bg-[#fdebd0] px-4 py-1 text-xs font-semibold uppercase tracking-wide shadow-[0_3px_0_#000]">
            From email <%= email.id %>
          </div>
        <% end %>
      </div>

      <div class="mt-5 text-base leading-7 text-slate-800">
        <% if @transaction.notes.present? %>
          <div class="prose max-w-none prose-slate">
            <%= simple_format(@transaction.notes) %>
          </div>
        <% else %>
          <p class="italic text-slate-500">No reviewer notes have been added for this transaction.</p>
        <% end %>
      </div>
    </div>

    <div class="rounded-3xl border-2 border-dashed border-black bg-white/80 p-6 shadow-[8px_8px_0_#000]">
      <div class="flex items-center justify-between gap-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Raw metadata</p>
          <p class="text-sm text-slate-500">Useful for debugging import issues</p>
        </div>
        <span class="rounded-full border-2 border-black bg-amber-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide shadow-[0_3px_0_#000]">
          Internal
        </span>
      </div>
      <pre class="mt-4 max-h-72 overflow-auto rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs leading-relaxed text-slate-700"><%= @transaction.metadata.presence || "No metadata stored." %></pre>
    </div>
  </div>
</div>