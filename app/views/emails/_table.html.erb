<% emails = emails.to_a %>
<% latest_timestamp = local_assigns.fetch(:latest_synced_at) { emails.first&.sent_at || emails.first&.created_at } %>

<div class="relative mt-6 space-y-4 rounded-3xl border-2 border-black bg-[#fdebd0] p-5 shadow-[12px_12px_0_#000]">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">Inbox</p>
      <p class="text-sm text-slate-600">
        Showing <%= emails.size %> synced <%= "email".pluralize(emails.size) %>
      </p>
    </div>
    <div class="rounded-full border-2 border-black bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wider text-slate-600 shadow-[0_3px_0_#000]">
      <% if latest_timestamp.present? %>
        Synced <%= time_ago_in_words(latest_timestamp) %> ago
      <% else %>
        Live sync
      <% end %>
    </div>
  </div>

  <div class="overflow-x-auto rounded-2xl border-2 border-black bg-white">
    <table class="min-w-full text-sm text-slate-800">
      <thead class="bg-slate-900 text-slate-100 text-left text-xs font-semibold uppercase tracking-[0.25em]">
        <tr>
          <th class="px-5 py-4">Conversation</th>
          <th class="px-5 py-4">Sender</th>
          <th class="px-5 py-4">Sent</th>
          <th class="px-5 py-4">Status</th>
          <th class="px-5 py-4 text-right">Action</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        <% emails.each do |email| %>
          <% subject = email.subject.presence || "(no subject)" %>
          <% snippet = email.snippet.presence || "No preview available yet." %>
          <% sender = email.from_address.presence || "Unknown sender" %>
          <% recipient = email.to_address.presence || "Not specified" %>
          <% sent_at = email.sent_at || email.created_at %>
          <% sent_timestamp = sent_at.present? ? sent_at.strftime("%b %d, %Y • %I:%M %p") : "Timestamp unavailable" %>
          <% relative_sent = sent_at.present? ? time_ago_in_words(sent_at) : nil %>
          <% status_label = email.processed? ? "Processed" : "Pending" %>
          <% status_styles = email.processed? ? "bg-emerald-300 text-emerald-900" : "bg-yellow-200 text-yellow-900" %>
          <% transaction = email.financial_transaction %>
          <tr class="group transition hover:bg-[#fff6eb]">
            <td class="px-5 py-4 align-top">
              <div class="font-semibold text-slate-900"><%= subject %></div>
              <p class="text-xs font-medium uppercase tracking-wide text-slate-500">Thread <%= email.thread_id.presence || "—" %></p>
              <p class="mt-2 text-xs text-slate-500"><%= truncate(snippet, length: 80) %></p>
            </td>
            <td class="px-5 py-4 align-top">
              <p class="font-semibold text-slate-900"><%= sender %></p>
              <p class="text-xs text-slate-500">To: <%= recipient %></p>
            </td>
            <td class="px-5 py-4 align-top">
              <p class="text-sm font-semibold text-slate-900"><%= sent_timestamp %></p>
              <p class="text-xs text-slate-500"><%= relative_sent.present? ? "#{relative_sent} ago" : "No relative time" %></p>
            </td>
            <td class="px-5 py-4 align-top">
              <span class="inline-flex items-center rounded-full border-2 border-black px-3 py-1 text-[11px] font-semibold uppercase tracking-wide shadow-[0_3px_0_#000] <%= status_styles %>">
                <%= status_label %>
              </span>
              <div class="mt-3 text-xs text-slate-600">
                <% if transaction.present? %>
                  <%= link_to transaction_path(transaction),
                      class: "inline-flex items-center gap-1 font-semibold text-blue-700 underline decoration-2",
                      data: { turbo_frame: "_top" } do %>
                    Linked transaction
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                  <% end %>
                <% else %>
                  <span class="text-slate-500">Awaiting extraction</span>
                <% end %>
              </div>
            </td>
            <td class="px-5 py-4 align-top text-right">
              <%= link_to email_path(email),
                  class: "inline-flex items-center gap-2 rounded-2xl border-2 border-black bg-amber-300 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-900 shadow-[0_4px_0_#000] transition hover:-translate-y-0.5",
                  data: { turbo_frame: "_top" } do %>
                Open
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              <% end %>
            </td>
          </tr>
        <% end %>

        <% if emails.blank? %>
          <tr>
            <td colspan="5" class="px-6 py-10 text-center">
              <div class="rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 px-6 py-8">
                <p class="text-lg font-semibold text-slate-700">No emails ingested yet</p>
                <p class="mt-1 text-sm text-slate-500">Connect an inbox or trigger a sync to start streaming receipts automatically.</p>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

